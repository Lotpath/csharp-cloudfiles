<?xml version="1.0" encoding="utf-8"?>
<project name="com.mosso.cloudfiles" default="complete" xmlns="http://nant.sf.net/schemas/nant.xsd">
  <include buildfile="properties.include" />

  <target name="complete" depends="clean, compile, setup, test, deploy" description="Compile and Run Tests" />

  <target name="clean" description="Deletes all generated folders and files to start with clean folder structure">
    <delete dir="${cloudfiles.builds.dir}" />
  </target>

  <target name="compile" depends="clean" description="Compiles debug solution">
    <call target="create.assemblyinfo" />

    <exec program="${msbuild}">
      <arg value="${sln.file}" />
      <arg value="/verbosity:minimal" />
      <arg value="/p:Configuration=${config}" />
      <arg value="/p:WarningLevel=0" />
    </exec>

    <move file="com.mosso.cloudfiles/Properties/AssemblyInfo_old.cs" tofile="com.mosso.cloudfiles/Properties/AssemblyInfo.cs" overwrite="true" />

    <copy todir="cloudfilesviewer\lib" overwrite="true">
      <fileset basedir="${core.project.original.dll.dir}">
        <include name="com.mosso.cloudfiles.dll" />
        <include name="com.mosso.cloudfiles.pdb" />
        <include name="Log4Net.config" />
        <include name="log4net.dll" />
      </fileset>
    </copy>
  </target>

  <target name="setup" depends="compile">
    <mkdir dir="${build.dir}" if="${not directory::exists(build.dir)}"/>
    <mkdir dir="${build.docs.dir}" if="${not directory::exists(build.docs.dir)}"/>
    <mkdir dir="${deploy.dir}" if="${not directory::exists(deploy.dir)}"/>
    <mkdir dir="${deploy.src.dir}" if="${not directory::exists(deploy.src.dir)}"/>
    <mkdir dir="${deploy.bin.dir}" if="${not directory::exists(deploy.bin.dir)}"/>
    <mkdir dir="${deploy.docs.dir}" if="${not directory::exists(deploy.docs.dir)}"/>
    <mkdir dir="${test.reports.dir}" if="${not directory::exists(test.reports.dir)}"/>
    <mkdir dir="${config.dir}" if="${not directory::exists(config.dir)}" />
    <mkdir dir="${unit.tests.dir}" if="${not directory::exists(unit.tests.dir)}" />
    <copy todir="${config.dir}">
      <fileset basedir="${core.project.original.dll.dir}">
        <include name="**/*" />
      </fileset>
    </copy>
    <copy todir="${unit.tests.dir}">
      <fileset basedir="${unit.tests.original.dll.dir}">
        <include name="**/*" />
      </fileset>
    </copy>
    <copy todir="${integration.tests.dir}">
      <fileset basedir="${integration.tests.original.dll.dir}">
        <exclude name="logs" />
        <include name="**/*" />
      </fileset>
    </copy>
  </target>

  <target name="test">
    <exec program="nunit-console.exe" basedir="lib\nunit">
      <arg value="${unit.tests.dir}\com.mosso.cloudfiles.unit.tests.dll" />
      <arg value="/xml:${test.reports.dir}\UnitTests.xml" />
    </exec>
    <exec program="nunit-console.exe" basedir="lib\nunit">
      <arg value="${integration.tests.dir}\com.mosso.cloudfiles.integration.tests.dll" />
      <arg value="/xml:${test.reports.dir}\IntegrationTests.xml" />
    </exec>
  </target>

  <target name="deploy">
    <call target="deploy.bin" />
    <call target="deploy.docs" />
    <call target="deploy.src" />
    <call target="deploy.package.master.zip" />
  </target>

  <target name="deploy.src">
    <zip zipfile="${deploy.src.dir}\${zip.file.prefix}-src-${cloud.files.release.build.number}.zip">
      <fileset basedir="${directory::get-current-directory()}">
        <exclude name="temp/**" />
        <exclude name="${build.dir}/**" />
        <exclude name="${deploy.dir}/**" />
        <exclude name=".git/**" />
        <exclude name=".gitignore" />
        <exclude name="*resharper*" />
        <exclude name="*ReSharper*/**" />
        <exclude name="*suo*" />
        <exclude name="*.cache*" />
        <exclude name="com.mosso.cloudfiles/bin/**" />
        <exclude name="com.mosso.cloudfiles/obj/**" />
        <exclude name="com.mosso.cloudfiles.integration.tests/bin/**" />
        <exclude name="com.mosso.cloudfiles.integration.tests/obj /**" />
        <exclude name="com.mosso.cloudfiles.unit.tests/bin/**" />
        <exclude name="com.mosso.cloudfiles.unit.tests/obj/**" />
        <exclude name="cloudfilesviewer/bin/**" />
        <exclude name="cloudfilesviewer/obj/**" />
        <include name="**" />
      </fileset>
    </zip>
  </target>

  <target name="deploy.bin">
    <zip zipfile="${deploy.bin.dir}\${zip.file.prefix}-bin-${cloud.files.release.build.number}.zip">
      <fileset basedir="${config.dir}">
        <exclude name ="*.pdb" />
        <exclude name ="*.xml" />
        <exclude name ="UnitTests/**" />
        <exclude name ="IntegrationTests/**" />
        <include name="**" />
      </fileset>
    </zip>
  </target>

  <target name="deploy.docs" description="creates documentation files and packages into zip file">
    <call target="create.docs" />
    <call target="package.docs" />
  </target>

  <target name="create.docs" depends="compile, setup">
    <exec program="docu.exe" basedir="lib\docu">
      <arg value="--output=${build.docs.dir}" />
      <arg value="${config.dir}\com.mosso.cloudfiles.dll" />
    </exec>
  </target>

  <target name="package.docs">
    <zip zipfile="${deploy.docs.dir}\${zip.file.prefix}-doc-${cloud.files.release.build.number}.zip">
      <fileset basedir="${build.docs.dir}">
        <include name="**" />
      </fileset>
    </zip>
  </target>

  <target name="create.assemblyinfo">
    <asminfo output="AssemblyInfo.cs" language="CSharp">
      <imports>
        <import namespace="System" />
        <import namespace="System.Reflection" />
        <import namespace="System.Runtime.InteropServices" />
      </imports>
      <attributes>
        <attribute type="ComVisibleAttribute" value="false" />
        <attribute type="CLSCompliantAttribute" value="true" />
        <attribute type="AssemblyVersionAttribute" value="${cloud.files.release.build.number}" />
        <attribute type="AssemblyFileVersionAttribute" value="${cloud.files.release.build.number}" />
        <attribute type="AssemblyTitleAttribute" value="com.mosso.cloudfiles" />
        <attribute type="AssemblyDescriptionAttribute" value="C#.NET API for Rackspace Cloud Files Cloud Storage" />
        <attribute type="AssemblyCopyrightAttribute" value="Copyright (c) 2008 2009, Rackspace Managed Hosting" />
        <attribute type="AssemblyCompanyAttribute" value="Rackspace Managed Hosting" />
      </attributes>
    </asminfo>
    <copy file="com.mosso.cloudfiles/Properties/AssemblyInfo.cs" tofile="com.mosso.cloudfiles/Properties/AssemblyInfo_old.cs" overwrite="true" />
    <copy file="AssemblyInfo.cs" tofile="com.mosso.cloudfiles/Properties/AssemblyInfo.cs" overwrite="true" />
    <delete file="AssemblyInfo.cs" />
  </target>
  
  <target name="deploy.package.master.zip">
    <zip zipfile="${deploy.dir}\${zip.file.prefix}-${cloud.files.release.build.number}.zip">
      <fileset basedir="${deploy.src.dir}">
        <include name="**" />
      </fileset>
      <fileset basedir="${deploy.bin.dir}">
        <include name="**" />
      </fileset>
      <fileset basedir="${deploy.example.dir}">
        <include name="**" />
      </fileset>
      <fileset basedir="${deploy.docs.dir}">
        <include name="**" />
      </fileset>
    </zip>
  </target>
</project>